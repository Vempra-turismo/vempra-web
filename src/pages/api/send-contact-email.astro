---
import { Resend } from 'resend';

// No proteger este endpoint, ya que es para usuarios públicos
if (Astro.request.method !== 'POST') {
    return new Response('Método no permitido', { status: 405 });
}

const resend = new Resend(import.meta.env.RESEND_API_KEY);

try {
    const formData = await Astro.request.formData();
    const nombre = formData.get('nombre')?.toString();
    const email = formData.get('email')?.toString();
    const telefono = formData.get('telefono')?.toString() || 'No proporcionado';
    const destinos = formData.get('destinos')?.toString() || 'No especificado';
    const fechas = formData.get('fechas')?.toString() || 'No especificadas';
    const pasajeros = formData.get('pasajeros')?.toString() || 'No especificado';
    const mensaje = formData.get('mensaje')?.toString();

    // Validación básica
    if (!nombre || !email || !mensaje) {
        return new Response("Faltan campos obligatorios.", { status: 400 });
    }

    // 1. Enviar email a la agencia
    await resend.emails.send({
        from: 'Vempra Web <no-reply@vempra.com.ar>', // Reemplazar con un dominio verificado en Resend
        to: 'paquetes@vempra.tur.ar',
        subject: `Nueva consulta de viaje de ${nombre}`,
        html: `
            <h1>Nueva consulta desde la web</h1>
            <p>Has recibido un nuevo mensaje de contacto. Aquí están los detalles:</p>
            <ul>
                <li><strong>Nombre:</strong> ${nombre}</li>
                <li><strong>Email:</strong> ${email}</li>
                <li><strong>Teléfono:</strong> ${telefono}</li>
                <li><strong>Destino/s de Interés:</strong> ${destinos}</li>
                <li><strong>Fechas Posibles:</strong> ${fechas}</li>
                <li><strong>Cantidad de Pasajeros:</strong> ${pasajeros}</li>
            </ul>
            <hr>
            <h2>Mensaje:</h2>
            <p style="white-space: pre-wrap;">${mensaje}</p>
        `
    });

    // 2. Enviar email de confirmación al cliente
    await resend.emails.send({
        from: 'Vempra Viajes <info@vempra.com.ar>', // Reemplazar con un dominio verificado en Resend
        to: email,
        subject: 'Hemos recibido tu consulta | Vempra Viajes',
        html: `
            <h1>¡Gracias por contactarnos, ${nombre}!</h1>
            <p>Hemos recibido tu consulta y uno de nuestros expertos en viajes se pondrá en contacto contigo a la brevedad para ayudarte a planificar tu próxima aventura.</p>
            <p>Recibimos los siguientes datos:</p>
            <ul>
                <li><strong>Destino/s:</strong> ${destinos}</li>
                <li><strong>Fechas:</strong> ${fechas}</li>
                <li><strong>Pasajeros:</strong> ${pasajeros}</li>
            </ul>
            <p>Si necesitas hacer algún cambio o tienes otra pregunta, no dudes en responder a este correo.</p>
            <br>
            <p>Saludos cordiales,</p>
            <p><strong>El equipo de Vempra Viajes</strong></p>
        `
    });

    // Redirigir a una página de agradecimiento
    return Astro.redirect('/gracias');

} catch (error) {
    console.error("Error al enviar el email:", error);
    return new Response("Hubo un error al procesar tu solicitud. Por favor, inténtalo de nuevo más tarde.", { status: 500 });
}
---
