---
import { Resend } from 'resend';

export async function POST({ request }) {
    if (request.headers.get("Content-Type") !== "application/json") {
        return new Response(JSON.stringify({ message: "Tipo de contenido no permitido" }), { status: 400 });
    }

    const resend = new Resend(import.meta.env.RESEND_API_KEY);
    const ADMIN_EMAIL = 'paquetes@vempra.tur.ar';
    const FROM_EMAIL = 'Vempra Web <consultas@vempra.tur.ar>'; // Reemplazar con un dominio verificado en Resend

    try {
        const data = await request.json();
        const { nombre, email, telefono, destinos, fechas, pasajeros, mensaje } = data;

        // Validación del lado del servidor
        if (!nombre || !email || !telefono || !mensaje) {
            return new Response(JSON.stringify({ message: 'Faltan campos obligatorios.' }), { status: 400 });
        }

        // 1. Enviar email a la agencia
        await resend.emails.send({
            from: FROM_EMAIL,
            to: ADMIN_EMAIL,
            subject: `Nueva consulta desde la web de: ${nombre}`,
            html: `
                <h1>Nueva consulta desde la web</h1>
                <p><strong>Nombre:</strong> ${nombre}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>Teléfono:</strong> ${telefono || 'No proporcionado'}</p>
                <p><strong>Destino/s de Interés:</strong> ${destinos || 'No especificado'}</p>
                <p><strong>Fechas Posibles:</strong> ${fechas || 'No especificadas'}</p>
                <p><strong>Cantidad de Pasajeros:</strong> ${pasajeros || 'No especificado'}</p>
                <hr>
                <h2>Mensaje:</h2>
                <p style="white-space: pre-wrap;">${mensaje}</p>
            `
        });

        // 2. Enviar email de confirmación al cliente
        await resend.emails.send({
            from: FROM_EMAIL,
            to: email,
            subject: 'Hemos recibido tu consulta | Vempra Viajes',
            html: `
                <h1>¡Gracias por contactarnos, ${nombre}!</h1>
                <p>Hemos recibido tu consulta y uno de nuestros expertos en viajes se pondrá en contacto contigo a la brevedad para ayudarte a planificar tu próxima aventura.</p>
                <p>Si necesitas hacer algún cambio o tienes otra pregunta, no dudes en responder a este correo.</p>
                <br>
                <p>Saludos cordiales,</p>
                <p><strong>El equipo de Vempra Viajes</strong></p>
            `
        });

        return new Response(JSON.stringify({ message: 'Consulta enviada con éxito' }), { status: 200 });

    } catch (error) {
        console.error("Error al enviar el email:", error);
        return new Response(JSON.stringify({ message: "Hubo un error al procesar tu solicitud." }), { status: 500 });
    }
}
---
